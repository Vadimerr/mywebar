<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>WebAR hit test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- Three.js и аддоны с CDN -->
  <script src="https://unpkg.com/three@0.163.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.163.0/examples/jsm/libs/stats.module.js" type="module"></script>
  <script src="https://unpkg.com/three@0.163.0/examples/jsm/webxr/ARButton.js" type="module"></script>
</head>
<body style="margin:0; overflow:hidden;">

<div id="info" style="position:absolute;top:10px;left:10px;color:#fff;z-index:5;">
  WebAR hit test
</div>

<script>
  let camera, scene, renderer;
  let controller1, controller2;
  let reticle;
  let hitTestSource = null;
  let hitTestSourceRequested = false;

  init();

  function init() {

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(
      70,
      window.innerWidth / window.innerHeight,
      0.01,
      20
    );

    const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
    light.position.set(0.5, 1, 0.25);
    scene.add(light);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Кнопка запуска AR
    if (navigator.xr) {
      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        if (supported) {
          const button = document.createElement('button');
          button.textContent = 'Запустить AR';
          button.style.position = 'absolute';
          button.style.left = '50%';
          button.style.top = '50%';
          button.style.transform = 'translate(-50%, -50%)';
          button.style.padding = '12px 20px';
          button.style.fontSize = '16px';
          button.style.zIndex = '10';
          document.body.appendChild(button);

          button.addEventListener('click', () => {
            button.remove();
            startAR();
          });
        } else {
          alert('Этот девайс не поддерживает AR‑режим в браузере');
        }
      });
    } else {
      alert('Браузер не поддерживает WebXR');
    }

    window.addEventListener('resize', onWindowResize);
  }

  async function startAR() {
    const sessionInit = { requiredFeatures: ['hit-test'] };

    const session = await navigator.xr.requestSession('immersive-ar', sessionInit);
    renderer.xr.setReferenceSpaceType('local');
    await renderer.xr.setSession(session);

    const geometry = new THREE.CylinderGeometry(0.1, 0.1, 0.2, 32).translate(0, 0.1, 0);

    function onSelect() {
      if (reticle.visible) {
        const material = new THREE.MeshPhongMaterial({ color: 0xffffff * Math.random() });
        const mesh = new THREE.Mesh(geometry, material);
        reticle.matrix.decompose(mesh.position, mesh.quaternion, mesh.scale);
        mesh.scale.y = Math.random() * 2 + 1;
        scene.add(mesh);
      }
    }

    controller1 = renderer.xr.getController(0);
    controller1.addEventListener('select', onSelect);
    scene.add(controller1);

    controller2 = renderer.xr.getController(1);
    controller2.addEventListener('select', onSelect);
    scene.add(controller2);

    reticle = new THREE.Mesh(
      new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
      new THREE.MeshBasicMaterial()
    );
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    const referenceSpace = await session.requestReferenceSpace('viewer');
    const hitTestSourceResult = await session.requestHitTestSource({ space: referenceSpace });
    hitTestSource = hitTestSourceResult;
    hitTestSourceRequested = true;

    session.addEventListener('end', () => {
      hitTestSourceRequested = false;
      hitTestSource = null;
    });

    renderer.setAnimationLoop(animate);
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animate(timestamp, frame) {
    if (frame && hitTestSourceRequested && hitTestSource) {
      const referenceSpace = renderer.xr.getReferenceSpace();
      const hitTestResults = frame.getHitTestResults(hitTestSource);

      if (hitTestResults.length) {
        const hit = hitTestResults[0];
        const pose = hit.getPose(referenceSpace);
        reticle.visible = true;
        reticle.matrix.fromArray(pose.transform.matrix);
      } else {
        reticle.visible = false;
      }
    }

    renderer.render(scene, camera);
  }
</script>
</body>
</html>
